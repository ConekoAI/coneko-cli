name: Test & Publish

on:
  push:
    branches: [main, develop]
    tags: ['v*.*.*']
  pull_request:
    branches: [main]

permissions:
  id-token: write  # Required for OIDC
  contents: read

jobs:
  unit-test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm test

      - name: Build
        run: npm run build

  e2e-test:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: unit-test
    if: github.event_name == 'push' || github.event_name == 'pull_request'
    steps:
      - name: Checkout coneko-cli
        uses: actions/checkout@v4
        with:
          path: coneko-cli

      - name: Checkout coneko-service
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/coneko-service
          path: coneko-service
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}

      - name: Create docker-compose.e2e.yml
        run: |
          cat > docker-compose.e2e.yml << 'EOF'
          version: '3.8'
          
          services:
            db:
              image: postgres:16-alpine
              environment:
                POSTGRES_USER: coneko
                POSTGRES_PASSWORD: testpass
                POSTGRES_DB: coneko_test
              ports:
                - "5432:5432"
              healthcheck:
                test: ["CMD-SHELL", "pg_isready -U coneko"]
                interval: 2s
                timeout: 5s
                retries: 10
          
            service:
              build:
                context: ./coneko-service
                dockerfile: Dockerfile.test
              ports:
                - "3000:3000"
              environment:
                DATABASE_URL: postgresql://coneko:testpass@db:5432/coneko_test
                NODE_ENV: test
                PORT: 3000
              depends_on:
                db:
                  condition: service_healthy
              healthcheck:
                test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health"]
                interval: 2s
                timeout: 5s
                retries: 10
          
            cli-tests:
              build:
                context: ./coneko-cli
                dockerfile: Dockerfile.test
              environment:
                CONEKO_API_URL: http://service:3000
                CONEKO_TEST_MODE: e2e
              depends_on:
                service:
                  condition: service_healthy
              volumes:
                - ./test-results:/app/test-results
          EOF

      - name: Start E2E environment
        run: |
          docker compose -f docker-compose.e2e.yml up --build --abort-on-container-exit cli-tests

      - name: Collect test results
        if: always()
        run: |
          mkdir -p test-results
          docker cp $(docker compose -f docker-compose.e2e.yml ps -q cli-tests):/app/test-results/. test-results/ || true

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: test-results/

      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.e2e.yml down -v

  publish:
    name: Publish to NPM
    runs-on: ubuntu-latest
    needs: [unit-test, e2e-test]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Publish to NPM with Provenance
        run: npm publish --access public --provenance
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        # Note: NPM_TOKEN can be empty if using Trusted Publisher (OIDC)
        # The --provenance flag enables attestation linking the package to this GitHub Action run
